version: '3'

services:
  devweek_webapp:
    image: devweek_webapp:latest
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
    ports: 
      - "20201:80"

  devweek_worker:
    image: devweek_worker:latest
    deploy:
      mode: replicated
      replicas: 3
      restart_policy:
        condition: on-failure
        delay: 10s
        max_attempts: 3
        window: 600s
      placement:
        constraints: [node.labels.appenv == prd]
    environment:
      - ASPNETCORE_ENVIRONMENT=Production

  rabbitmq:
    ports: 
      - "20202:15672"

  s3:
    ports: 
      - "20203:15672"

  redis:
    ports:
      - "20204:6379"
